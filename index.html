<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>faceRoster</title>
    <script src="js/face-api.js"></script>
</head>

<body>
    <label>Upload Image:</label> <input id="queryImgUploadInput" type="file" onchange="uploadQueryImage(event)" accept=".jpg, .jpeg, .png">
    <div id="imagediv">
        <img id="myImg" src="bbt1.jpg" alt="">
    </div>
    <script>
    const tiny = false;
    var personDescriptors = [];
    var faceMatcher;
    console.time();

    function drawFaceRecognitionResults(results) {
        let paras = document.getElementsByClassName('faceNames');
        while (paras[0]) {
            paras[0].parentNode.removeChild(paras[0]);
        }
        results.forEach(function(result) {
            let btn = document.createElement("button");
            if (result.bestMatch.label != 'unknown') {
                btn.innerText = result.bestMatch.label;
            } else {
                btn.innerText = result.age.toFixed(0) + ' year old ' + result.expressions.asSortedArray()[0].expression + ' ' + result.gender;
            }
            btn.style = 'position:absolute; top:' + result.detection.box.top + 'px;left:' + result.detection.box.left + 'px; zindex:2';
            btn.className = 'faceNames';
            btn.dataset.person = result.bestMatch.label;
            btn.dataset.descriptor = result.descriptor;
            btn.addEventListener("click", personClick);;
            document.getElementById("imagediv").appendChild(btn);
        })
    }

    async function createFaceMatcher() {
        personDescriptors.sort();
        labeledFaceDescriptors = [];
        let descriptors = []
        var currentName = "";
        for (let i = 0; i < personDescriptors.length; i++) {
            if (personDescriptors[i].person !== currentName) {
                descriptors = [];
                currentName = personDescriptors[i].person;
            }

            descriptors.push(new Float32Array(Object.values(personDescriptors[i].descriptor)));

            if (personDescriptors.length > (i + 1)) {
                if (personDescriptors[i].person == personDescriptors[i + 1].person) {
                    continue;
                }
            }
            labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(currentName, descriptors));
        }

        const maxDescriptorDistance = 0.5
        faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, maxDescriptorDistance)

        return faceMatcher;
    }

    function addDescriptor(newPerson, descriptor) {
        let entry = {};
        entry.person = newPerson;
        entry.descriptor = descriptor
        personDescriptors.push(entry);
        personDescriptors.sort();
    }

    function personClick(e) {
        var newPerson = prompt("Please enter person's name:", e.target.dataset.person);
        if (newPerson == null || newPerson == "" || newPerson == "unknown") {} else {
            console.time();
            e.target.dataset.person = newPerson;
            e.target.innerHTML = newPerson;
            let descriptor = {};
            let d = e.target.dataset.descriptor.split(',');
            for (var i = 0; i < d.length; i++) {
                descriptor[i.toString()] = Number(d[i]);
            }
            addDescriptor(newPerson, descriptor);
            createFaceMatcher().then(updateResults);
        }
    }

    async function loadModels() {
        if (tiny) {
            await faceapi.nets.tinyFaceDetector.load("weights");
            await faceapi.nets.faceLandmark68TinyNet.load("weights");
        } else {
            await faceapi.nets.ssdMobilenetv1.load("weights");
            await faceapi.nets.faceLandmark68Net.load("weights");
        }
        await faceapi.nets.faceExpressionNet.load("weights");
        await faceapi.nets.ageGenderNet.load("weights");
        await faceapi.nets.faceRecognitionNet.loadFromUri('weights')

        console.timeLog();
    }

    async function updateResults() {
        if (tiny) {
            results = await faceapi.detectAllFaces("myImg", new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks(true).withFaceExpressions().withAgeAndGender().withFaceDescriptors();
        } else {
            results = await faceapi.detectAllFaces("myImg").withFaceLandmarks().withFaceExpressions().withAgeAndGender().withFaceDescriptors();
        }

        if (!results.length) {
            drawFaceRecognitionResults(results);
            return
        }

        // create FaceMatcher with automatically assigned labels
        // from the detection results for the reference image
        if (faceMatcher == null) {
            faceMatcher = await new faceapi.FaceMatcher(results);
        }

        results.forEach(function(result, i, results) {
            results[i].bestMatch = faceMatcher.findBestMatch(result.descriptor)
        })

        drawFaceRecognitionResults(results);

        // console.log(results)
        console.timeEnd();
    }

    async function uploadQueryImage(e) {
        console.time();
        const imgFile = e.target.files[0]
        const img = await faceapi.bufferToImage(imgFile)
        document.getElementById("myImg").src = img.src
        updateResults()
    }

    loadModels().then(updateResults)
    </script>
</body>

</html>